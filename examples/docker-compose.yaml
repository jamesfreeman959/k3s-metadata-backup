version: '3.8'

services:
  k3s-backup-verify:
    image: YOUR_USERNAME/k3s-metadata-backup:latest
    container_name: k3s-backup-verify
    command: ["verify-all", "--format", "json"]
    volumes:
      # Mount kubeconfig for cluster access
      - ~/.kube/config:/root/.kube/config:ro
    environment:
      # Cluster configuration
      CLUSTER_NAME: k3sdev

      # S3 configuration
      S3_ETCD_PREFIX: k3s-etcd-snapshots/
      S3_PV_BACKUP_PREFIX: pv-backups/
      S3_NODES_BACKUP_PREFIX: nodes-backups/

      # Backup thresholds
      ETCD_BACKUP_MAX_AGE_HOURS: "24"
      LONGHORN_BACKUP_MAX_AGE_HOURS: "48"

      # Retention
      RETENTION_PV_BACKUPS: "30"
      RETENTION_NODE_BACKUPS: "30"

      # IMPORTANT: Replace with your Bitwarden secret UUIDs
      BWS_SECRET_ID_ACCESS_KEY: your-uuid-here
      BWS_SECRET_ID_SECRET_KEY: your-uuid-here
      BWS_SECRET_ID_ENDPOINT: your-uuid-here
      BWS_SECRET_ID_REGION: your-uuid-here
      BWS_SECRET_ID_BUCKET: your-uuid-here
    restart: "no"

  k3s-backup-pvs:
    image: YOUR_USERNAME/k3s-metadata-backup:latest
    container_name: k3s-backup-pvs
    command: ["backup-pvs"]
    volumes:
      - ~/.kube/config:/root/.kube/config:ro
    environment:
      CLUSTER_NAME: k3sdev
      S3_PV_BACKUP_PREFIX: pv-backups/
      RETENTION_PV_BACKUPS: "30"
      BWS_SECRET_ID_ACCESS_KEY: your-uuid-here
      BWS_SECRET_ID_SECRET_KEY: your-uuid-here
      BWS_SECRET_ID_ENDPOINT: your-uuid-here
      BWS_SECRET_ID_REGION: your-uuid-here
      BWS_SECRET_ID_BUCKET: your-uuid-here
    restart: "no"

  k3s-backup-nodes:
    image: YOUR_USERNAME/k3s-metadata-backup:latest
    container_name: k3s-backup-nodes
    command: ["backup-nodes"]
    volumes:
      - ~/.kube/config:/root/.kube/config:ro
    environment:
      CLUSTER_NAME: k3sdev
      S3_NODES_BACKUP_PREFIX: nodes-backups/
      RETENTION_NODE_BACKUPS: "30"
      BWS_SECRET_ID_ACCESS_KEY: your-uuid-here
      BWS_SECRET_ID_SECRET_KEY: your-uuid-here
      BWS_SECRET_ID_ENDPOINT: your-uuid-here
      BWS_SECRET_ID_REGION: your-uuid-here
      BWS_SECRET_ID_BUCKET: your-uuid-here
    restart: "no"
